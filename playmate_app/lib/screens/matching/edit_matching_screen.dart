import 'package:flutter/material.dart';
import '../../models/matching.dart';
import '../../constants/app_colors.dart';
import '../../constants/app_text_styles.dart';
import '../../widgets/common/app_button.dart';
import '../../services/matching_data_service.dart';

class EditMatchingScreen extends StatefulWidget {
  final Matching matching;
  final VoidCallback? onMatchingUpdated;

  const EditMatchingScreen({
    super.key,
    required this.matching,
    this.onMatchingUpdated,
  });

  @override
  State<EditMatchingScreen> createState() => _EditMatchingScreenState();
}

class _EditMatchingScreenState extends State<EditMatchingScreen> {
  final _formKey = GlobalKey<FormState>();
  final _courtNameController = TextEditingController();
  final _messageController = TextEditingController();
  final _guestCostController = TextEditingController();
  
  DateTime _selectedDate = DateTime.now();
  String _selectedTimeSlot = '09:00-11:00';
  String _selectedGameType = 'mixed';
  int _maleRecruitCount = 1;
  int _femaleRecruitCount = 1;
  int? _minLevel;
  int? _maxLevel;
  int? _minAge;
  int? _maxAge;
  int? _guestCost;
  bool _isFollowersOnly = false;
  bool _noAgeRestriction = false;
  
  bool _isLoading = false;

  final List<String> _timeSlots = [
    '06:00~08:00',
    '08:00~10:00',
    '09:00~11:00',
    '10:00~12:00',
    '12:00~14:00',
    '14:00~16:00',
    '16:00~18:00',
    '18:00~20:00',
    '20:00~22:00',
  ];

  final List<String> _gameTypes = [
    'mixed',
    'male_doubles',
    'female_doubles',
    'singles',
    'rally',
  ];

  @override
  void initState() {
    super.initState();
    _initializeForm();
    // setStateÎ•º Ìò∏Ï∂úÌïòÏó¨ UI ÏóÖÎç∞Ïù¥Ìä∏ Í∞ïÏ†ú
    WidgetsBinding.instance.addPostFrameCallback((_) {
      setState(() {});
    });
  }

  void _initializeForm() {
    print('üîç EditMatchingScreen Ï¥àÍ∏∞Ìôî:');
    print('  - ÏΩîÌä∏ Ïù¥Î¶Ñ: ${widget.matching.courtName}');
    print('  - ÎÇ®ÏÑ± Î™®Ïßë: ${widget.matching.maleRecruitCount}');
    print('  - Ïó¨ÏÑ± Î™®Ïßë: ${widget.matching.femaleRecruitCount}');
    print('  - Í≤åÏä§Ìä∏ ÎπÑÏö©: ${widget.matching.guestCost}');
    print('  - Í≤åÏûÑ ÌÉÄÏûÖ: ${widget.matching.gameType}');
    print('  - ÏãúÍ∞ÑÎåÄ: ${widget.matching.timeSlot}');
    print('  - ÏµúÏÜå Ïó∞Î†π: ${widget.matching.minAge}');
    print('  - ÏµúÎåÄ Ïó∞Î†π: ${widget.matching.maxAge}');
    
    _courtNameController.text = widget.matching.courtName;
    _messageController.text = widget.matching.message ?? '';
    _guestCostController.text = widget.matching.guestCost?.toString() ?? '';
    _selectedDate = widget.matching.date;
    _selectedTimeSlot = widget.matching.timeSlot;
    _selectedGameType = widget.matching.gameType;
    _maleRecruitCount = widget.matching.maleRecruitCount;
    _femaleRecruitCount = widget.matching.femaleRecruitCount;
    _minLevel = widget.matching.minLevel;
    _maxLevel = widget.matching.maxLevel;
    _minAge = widget.matching.minAge;
    _maxAge = widget.matching.maxAge;
    _guestCost = widget.matching.guestCost;
    _isFollowersOnly = widget.matching.isFollowersOnly;
    _noAgeRestriction = widget.matching.minAge == null && widget.matching.maxAge == null;
    
    print('üîç Ïó∞Î†πÎåÄ Ï¥àÍ∏∞Ìôî:');
    print('  - minAge: ${widget.matching.minAge}');
    print('  - maxAge: ${widget.matching.maxAge}');
    print('  - _noAgeRestriction: $_noAgeRestriction');
    print('  - _minAge: $_minAge');
    print('  - _maxAge: $_maxAge');
    
    print('üîç Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:');
    print('  - _maleRecruitCount: $_maleRecruitCount');
    print('  - _femaleRecruitCount: $_femaleRecruitCount');
    print('  - _guestCost: $_guestCost');
    print('  - _guestCostController.text: ${_guestCostController.text}');
    print('  - _minAge: $_minAge');
    print('  - _maxAge: $_maxAge');
    
    // UI ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ setState Ìò∏Ï∂ú
    setState(() {});
  }

  @override
  void dispose() {
    _courtNameController.dispose();
    _messageController.dispose();
    _guestCostController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Îß§Ïπ≠ ÏàòÏ†ï'),
        backgroundColor: AppColors.surface,
        elevation: 0,
        actions: [
          TextButton(
            onPressed: _isLoading ? null : _saveMatching,
            child: Text(
              'Ï†ÄÏû•',
              style: AppTextStyles.body.copyWith(
                color: _isLoading ? AppColors.textSecondary : AppColors.primary,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ],
      ),
      body: _isLoading
          ? const Center(
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  CircularProgressIndicator(
                    color: AppColors.primary,
                  ),
                  SizedBox(height: 16),
                  Text(
                    'Îß§Ïπ≠ÏùÑ ÏàòÏ†ïÌïòÎäî Ï§ë...',
                    style: TextStyle(
                      color: AppColors.textSecondary,
                    ),
                  ),
                ],
              ),
            )
          : SingleChildScrollView(
              padding: const EdgeInsets.all(16),
              child: Form(
                key: _formKey,
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildBasicInfoSection(),
                    const SizedBox(height: 24),
                    _buildDateTimeSection(),
                    const SizedBox(height: 24),
                    _buildGameInfoSection(),
                    const SizedBox(height: 24),
                    _buildRecruitInfoSection(),
                    const SizedBox(height: 24),
                    _buildLevelAgeSection(),
                    const SizedBox(height: 24),
                    _buildCostSection(),
                    const SizedBox(height: 24),
                    _buildMessageSection(),
                    const SizedBox(height: 24),
                    _buildPrivacySection(),
                    const SizedBox(height: 32),
                    _buildSaveButton(),
                  ],
                ),
              ),
            ),
    );
  }

  Widget _buildBasicInfoSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Í∏∞Î≥∏ Ï†ïÎ≥¥',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        TextFormField(
          controller: _courtNameController,
          decoration: const InputDecoration(
            labelText: 'ÏΩîÌä∏ Ïù¥Î¶Ñ',
            hintText: 'Ïòà: Í∞ïÎÇ® ÌÖåÎãàÏä§Ïû•',
            border: OutlineInputBorder(),
          ),
          validator: (value) {
            if (value == null || value.trim().isEmpty) {
              return 'ÏΩîÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
            }
            return null;
          },
        ),
      ],
    );
  }

  Widget _buildDateTimeSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ÎÇ†Ïßú Î∞è ÏãúÍ∞Ñ',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: InkWell(
                onTap: _selectDate,
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    border: Border.all(color: AppColors.cardBorder),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      const Icon(Icons.calendar_today, size: 20),
                      const SizedBox(width: 8),
                      Text(
                        '${_selectedDate.year}.${_selectedDate.month.toString().padLeft(2, '0')}.${_selectedDate.day.toString().padLeft(2, '0')}',
                        style: AppTextStyles.body,
                      ),
                    ],
                  ),
                ),
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: DropdownButtonFormField<String>(
                value: _selectedTimeSlot,
                decoration: const InputDecoration(
                  labelText: 'ÏãúÍ∞ÑÎåÄ',
                  border: OutlineInputBorder(),
                ),
                items: _timeSlots.map((slot) {
                  return DropdownMenuItem(
                    value: slot,
                    child: Text(slot),
                  );
                }).toList(),
                onChanged: (value) {
                  setState(() {
                    _selectedTimeSlot = value!;
                  });
                },
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildGameInfoSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Í≤åÏûÑ Ï†ïÎ≥¥',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        DropdownButtonFormField<String>(
          value: _selectedGameType,
          decoration: const InputDecoration(
            labelText: 'Í≤åÏûÑ ÌÉÄÏûÖ',
            border: OutlineInputBorder(),
          ),
          items: _gameTypes.map((type) {
            String displayName;
            switch (type) {
              case 'mixed':
                displayName = 'ÌòºÌï© Î≥µÏãù';
                break;
              case 'male_doubles':
                displayName = 'ÎÇ®Ïûê Î≥µÏãù';
                break;
              case 'female_doubles':
                displayName = 'Ïó¨Ïûê Î≥µÏãù';
                break;
              case 'singles':
                displayName = 'Îã®Ïãù';
                break;
              case 'rally':
                displayName = 'Îû†Î¶¨';
                break;
              default:
                displayName = type;
            }
            return DropdownMenuItem(
              value: type,
              child: Text(displayName),
            );
          }).toList(),
          onChanged: (value) {
            setState(() {
              _selectedGameType = value!;
            });
          },
        ),
      ],
    );
  }

  Widget _buildRecruitInfoSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Î™®Ïßë Ïù∏Ïõê',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('ÎÇ®ÏÑ±'),
                  const SizedBox(height: 8),
                  Row(
                    children: [
                      IconButton(
                        onPressed: _maleRecruitCount > 0
                            ? () => setState(() => _maleRecruitCount--)
                            : null,
                        icon: const Icon(Icons.remove),
                      ),
                      Text(
                        '$_maleRecruitCount',
                        style: AppTextStyles.h3,
                      ),
                      IconButton(
                        onPressed: () => setState(() => _maleRecruitCount++),
                        icon: const Icon(Icons.add),
                      ),
                    ],
                  ),
                ],
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('Ïó¨ÏÑ±'),
                  const SizedBox(height: 8),
                  Row(
                    children: [
                      IconButton(
                        onPressed: _femaleRecruitCount > 0
                            ? () => setState(() => _femaleRecruitCount--)
                            : null,
                        icon: const Icon(Icons.remove),
                      ),
                      Text(
                        '$_femaleRecruitCount',
                        style: AppTextStyles.h3,
                      ),
                      IconButton(
                        onPressed: () => setState(() => _femaleRecruitCount++),
                        icon: const Icon(Icons.add),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      ],
    );
  }

  Widget _buildLevelAgeSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Íµ¨Î†• Î∞è Ïó∞Î†π (ÏÑ†ÌÉùÏÇ¨Ìï≠)',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        Row(
          children: [
            Expanded(
              child: DropdownButtonFormField<int?>(
                value: _minLevel,
                decoration: const InputDecoration(
                  labelText: 'ÏµúÏÜå Íµ¨Î†•',
                  border: OutlineInputBorder(),
                ),
                items: [
                  const DropdownMenuItem<int?>(
                    value: null,
                    child: Text('Ï†úÌïú ÏóÜÏùå'),
                  ),
                  ...List.generate(10, (index) {
                    return DropdownMenuItem<int?>(
                      value: index + 1,
                      child: Text('${index + 1}ÎÖÑ'),
                    );
                  }),
                ],
                onChanged: (value) {
                  setState(() {
                    _minLevel = value;
                  });
                },
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: DropdownButtonFormField<int?>(
                value: _maxLevel,
                decoration: const InputDecoration(
                  labelText: 'ÏµúÎåÄ Íµ¨Î†•',
                  border: OutlineInputBorder(),
                ),
                items: [
                  const DropdownMenuItem<int?>(
                    value: null,
                    child: Text('Ï†úÌïú ÏóÜÏùå'),
                  ),
                  ...List.generate(10, (index) {
                    return DropdownMenuItem<int?>(
                      value: index + 1,
                      child: Text('${index + 1}ÎÖÑ'),
                    );
                  }),
                ],
                onChanged: (value) {
                  setState(() {
                    _maxLevel = value;
                  });
                },
              ),
            ),
          ],
        ),
        const SizedBox(height: 16),
        // Ïó∞Î†π Ï†úÌïú ÏóÜÏùå Ï≤¥ÌÅ¨Î∞ïÏä§
        CheckboxListTile(
          title: const Text('Ïó∞Î†π ÏÉÅÍ¥ÄÏóÜÏùå'),
          value: _noAgeRestriction,
          onChanged: (value) {
            setState(() {
              _noAgeRestriction = value ?? false;
              if (_noAgeRestriction) {
                _minAge = null;
                _maxAge = null;
              }
            });
          },
          controlAffinity: ListTileControlAffinity.leading,
        ),
        const SizedBox(height: 8),
        if (!_noAgeRestriction) ...[
          Row(
            children: [
              Expanded(
                child: DropdownButtonFormField<int?>(
                  value: _minAge,
                  decoration: const InputDecoration(
                    labelText: 'ÏµúÏÜå Ïó∞Î†π',
                    border: OutlineInputBorder(),
                  ),
                items: [
                  const DropdownMenuItem<int?>(
                    value: null,
                    child: Text('Ï†úÌïú ÏóÜÏùå'),
                  ),
                  ...List.generate(8, (index) {
                    final age = (index + 1) * 10;
                    return DropdownMenuItem<int?>(
                      value: age,
                      child: Text('${age}ÎåÄ'),
                    );
                  }),
                  // 49ÏÑ∏ Í∞ôÏùÄ Ï§ëÍ∞ÑÍ∞íÎèÑ ÏßÄÏõê
                  const DropdownMenuItem<int?>(
                    value: 49,
                    child: Text('40ÎåÄ'),
                  ),
                  const DropdownMenuItem<int?>(
                    value: 59,
                    child: Text('50ÎåÄ'),
                  ),
                ],
                onChanged: (value) {
                  setState(() {
                    _minAge = value;
                  });
                },
              ),
            ),
            const SizedBox(width: 16),
            Expanded(
              child: DropdownButtonFormField<int?>(
                value: _maxAge,
                decoration: const InputDecoration(
                  labelText: 'ÏµúÎåÄ Ïó∞Î†π',
                  border: OutlineInputBorder(),
                ),
                items: [
                  const DropdownMenuItem<int?>(
                    value: null,
                    child: Text('Ï†úÌïú ÏóÜÏùå'),
                  ),
                  ...List.generate(8, (index) {
                    final age = (index + 1) * 10;
                    return DropdownMenuItem<int?>(
                      value: age,
                      child: Text('${age}ÎåÄ'),
                    );
                  }),
                  // 49ÏÑ∏ Í∞ôÏùÄ Ï§ëÍ∞ÑÍ∞íÎèÑ ÏßÄÏõê
                  const DropdownMenuItem<int?>(
                    value: 49,
                    child: Text('40ÎåÄ'),
                  ),
                  const DropdownMenuItem<int?>(
                    value: 59,
                    child: Text('50ÎåÄ'),
                  ),
                ],
                onChanged: (value) {
                  setState(() {
                    _maxAge = value;
                  });
                },
              ),
            ),
          ],
        ),
        ],
      ],
    );
  }

  Widget _buildCostSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'ÎπÑÏö© (ÏÑ†ÌÉùÏÇ¨Ìï≠)',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        TextFormField(
          controller: _guestCostController,
          keyboardType: TextInputType.number,
          decoration: const InputDecoration(
            labelText: 'Í≤åÏä§Ìä∏ ÎπÑÏö© (Ïõê)',
            hintText: 'Ïòà: 15000',
            border: OutlineInputBorder(),
            suffixText: 'Ïõê',
          ),
          onChanged: (value) {
            _guestCost = int.tryParse(value);
          },
        ),
      ],
    );
  }

  Widget _buildMessageSection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Î©îÏãúÏßÄ (ÏÑ†ÌÉùÏÇ¨Ìï≠)',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        TextFormField(
          controller: _messageController,
          maxLines: 3,
          decoration: const InputDecoration(
            labelText: 'Îß§Ïπ≠Ïóê ÎåÄÌïú Ï∂îÍ∞Ä Ï†ïÎ≥¥',
            hintText: 'Ïòà: Ï¥àÎ≥¥Ïûê ÌôòÏòÅ, Ïã§ÎÇ¥ ÏΩîÌä∏ÏûÖÎãàÎã§',
            border: OutlineInputBorder(),
          ),
        ),
      ],
    );
  }

  Widget _buildPrivacySection() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Í≥µÍ∞ú ÏÑ§Ï†ï',
          style: AppTextStyles.h3.copyWith(
            color: AppColors.textPrimary,
          ),
        ),
        const SizedBox(height: 16),
        SwitchListTile(
          title: const Text('ÌåîÎ°úÏõåÎßå Î≥¥Í∏∞'),
          subtitle: const Text('ÎÇòÎ•º ÌåîÎ°úÏö∞ÌïòÎäî ÏÇ¨Ïö©ÏûêÎßå Ïù¥ Îß§Ïπ≠ÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§'),
          value: _isFollowersOnly,
          onChanged: (value) {
            setState(() {
              _isFollowersOnly = value;
            });
          },
          activeColor: AppColors.primary,
        ),
      ],
    );
  }

  Widget _buildSaveButton() {
    return SizedBox(
      width: double.infinity,
      child: AppButton(
        text: 'Îß§Ïπ≠ ÏàòÏ†ï',
        type: ButtonType.primary,
        onPressed: _isLoading ? null : _saveMatching,
      ),
    );
  }

  Future<void> _selectDate() async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: _selectedDate,
      firstDate: DateTime.now(),
      lastDate: DateTime.now().add(const Duration(days: 365)),
    );
    if (picked != null && picked != _selectedDate) {
      setState(() {
        _selectedDate = picked;
      });
    }
  }

  Future<void> _saveMatching() async {
    if (!_formKey.currentState!.validate()) {
      return;
    }

    setState(() {
      _isLoading = true;
    });

    try {
      // ÏàòÏ†ïÎêú Îß§Ïπ≠ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
      final updatedMatching = widget.matching.copyWith(
        courtName: _courtNameController.text.trim(),
        date: _selectedDate,
        timeSlot: _selectedTimeSlot,
        gameType: _selectedGameType,
        maleRecruitCount: _maleRecruitCount,
        femaleRecruitCount: _femaleRecruitCount,
        minLevel: _minLevel,
        maxLevel: _maxLevel,
        minAge: _minAge,
        maxAge: _maxAge,
        guestCost: _guestCost,
        message: _messageController.text.trim().isEmpty ? null : _messageController.text.trim(),
        isFollowersOnly: _isFollowersOnly,
      );

      // API Ìò∏Ï∂úÎ°ú Îß§Ïπ≠ ÏàòÏ†ï
      final success = await MatchingDataService.updateMatching(
        widget.matching.id,
        updatedMatching.toJson(),
      );

      if (success) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Îß§Ïπ≠Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.'),
            backgroundColor: Colors.green,
          ),
        );
        // ÏΩúÎ∞± Ìò∏Ï∂ú
        widget.onMatchingUpdated?.call();
        Navigator.of(context).pop(true); // ÏàòÏ†ï ÏôÑÎ£å ÌëúÏãú
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text('Îß§Ïπ≠ ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'),
            backgroundColor: Colors.red,
          ),
        );
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: $e'),
          backgroundColor: Colors.red,
        ),
      );
    } finally {
      setState(() {
        _isLoading = false;
      });
    }
  }
}
